<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grammar Spy™ — Case Interview</title>
  <link rel="icon" type="image/svg+xml" href="assets/brand/favicon.svg" />
  <style>
    :root{--navy:#0b1020;--mid:#16223a;--teal:#1f5f63;--light:#f2f4f7;--line:#d9dee6;--slate:#4a5568;--ok:#1f8f63;--bad:#b04444;--shadow:0 10px 20px rgba(11,16,32,.08)}
    *{box-sizing:border-box}
    body{margin:0;background:var(--light);color:var(--mid);font-family:Inter,Montserrat,Poppins,Outfit,"Segoe UI",sans-serif;padding:22px 14px 34px}
    .wrap{max-width:1040px;margin:0 auto;display:grid;gap:14px}
    .panel{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .head{padding:16px;display:grid;gap:8px}
    .k{margin:0;font:800 11px Inter,Arial,sans-serif;letter-spacing:.14em;text-transform:uppercase;color:var(--teal)}
    h1{margin:0;font-size:32px;line-height:1.08;color:var(--navy)}
    .sub{margin:0;color:var(--slate)}
    .hud{padding:0 16px 16px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .chip{border:1px solid var(--line);border-radius:10px;background:#f8fafc;padding:9px 10px;display:grid;gap:2px}
    .chip b{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--slate)}
    .chip span{font-weight:800;color:var(--mid)}
    .play{padding:16px;display:grid;gap:12px}
    .scene{border:1px solid var(--line);border-radius:14px;background:#fbfdff;padding:12px;display:grid;gap:8px}
    .scene p{margin:0}
    .scene .title{font-size:20px;font-weight:800;color:var(--navy)}
    .scene .line{font-size:14px;color:var(--slate);line-height:1.5}
    .ask{font-size:14px;color:var(--mid);font-weight:800}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .opt{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px;text-align:left;cursor:pointer;display:grid;gap:4px;transition:transform .14s ease,border-color .14s ease,box-shadow .14s ease}
    .opt:hover{transform:translateY(-1px);border-color:#c9a227;box-shadow:0 8px 14px rgba(11,16,32,.09)}
    .opt b{font-size:12px;letter-spacing:.1em;text-transform:uppercase;color:var(--teal)}
    .opt span{font-size:14px;color:var(--mid);line-height:1.35}
    .opt.good{border-color:#4fb28c;background:#f2fbf7}
    .opt.bad{border-color:#d47f7f;background:#fff7f7}
    .feedback{min-height:24px;font-weight:700}
    .feedback.ok{color:var(--ok)} .feedback.bad{color:var(--bad)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;text-decoration:none;border:1px solid var(--line);border-radius:10px;padding:11px 14px;background:#fff;color:var(--mid);text-transform:uppercase;letter-spacing:.08em;font-size:12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--teal);border-color:#194f53;color:#fff}
    .overlay{position:fixed;inset:0;background:rgba(11,16,32,.35);display:none;place-items:center;padding:14px;z-index:120}
    .overlay.show{display:grid}
    .modal{width:min(640px,100%);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 34px rgba(11,16,32,.22);padding:16px;display:grid;gap:10px}
    .modal h2{margin:0;font-size:30px;color:var(--navy)} .lineout{margin:0;color:var(--slate)}
    @media (max-width:900px){.hud{grid-template-columns:1fr 1fr}.options{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div data-include="header"></div>
  <main class="wrap">
    <section class="panel">
      <div class="head">
        <p class="k">Retell What Happened · Context Mission</p>
        <h1>Case Interview</h1>
        <p class="sub">Interview witnesses and choose the sentence that best fits each real classroom scene.</p>
      </div>
      <div class="hud">
        <div class="chip"><b>Case</b><span id="hudProgress">1/8</span></div>
        <div class="chip"><b>Accuracy</b><span id="hudAcc">0%</span></div>
        <div class="chip"><b>Streak</b><span id="hudStreak">0</span></div>
        <div class="chip"><b>Timer</b><span id="hudTimer">--</span></div>
      </div>
      <div class="play">
        <div class="scene">
          <p class="k">Scene File</p>
          <p class="title" id="sceneTitle">Loading...</p>
          <p class="line" id="sceneLine">Loading...</p>
          <p class="ask" id="sceneAsk">Choose the best interview line:</p>
        </div>
        <div class="options" id="options"></div>
        <p class="feedback" id="feedback"></p>
        <div class="row">
          <button class="btn" id="btnEnd" type="button">End Mission</button>
          <button class="btn" id="btnSound" type="button">Sound: ON</button>
          <a class="btn" href="index.html">Home</a>
        </div>
      </div>
    </section>
  </main>

  <div id="howToPlayOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="howToPlayTitle" style="display:none">
    <section class="modal">
      <h2 id="howToPlayTitle">How to play: Case Interview</h2>
      <p class="lineout">Read each classroom scene and the witness line. Choose the option that best completes or corrects the sentence. You get instant feedback and can build a streak.</p>
      <div class="row">
        <button class="btn primary" id="btnCloseHowToPlay" type="button">Got it — Start</button>
      </div>
    </section>
  </div>

  <div class="overlay" id="overlay">
    <section class="modal">
      <h2>Mission Report</h2>
      <p class="lineout" id="repAcc"></p>
      <p class="lineout" id="repStrong"></p>
      <p class="lineout" id="repWeak"></p>
      <div class="row">
        <button class="btn primary" id="btnAgain" type="button">Play Again</button>
        <a class="btn" href="teacher-mode.html">Teacher Mode</a>
      </div>
    </section>
  </div>

  <div data-include="footer"></div>
  <script src="billing-scaffold.js"></script>
  <script src="auth-scaffold.js"></script>
  <script src="layout-loader.js"></script>
  <script src="app-shell.js"></script>
  <script src="game-sound.js"></script>
  <script>
    const BANK = [
      {
        title: "Hallway Before First Period",
        line: "A student says: 'When the bell rang, we ___ our warm-up.'",
        ask: "Which response best completes the witness statement?",
        options: [
          { t: "were starting", ok: true, why: "Background action interrupted by the bell." },
          { t: "start", ok: false, why: "Needs past context, not base form." },
          { t: "are starting", ok: false, why: "Present form does not match the event timeline." },
          { t: "started", ok: false, why: "Possible meaning shift, but scene targets interrupted action." }
        ],
        skill: "timeline"
      },
      {
        title: "Office Announcement Draft",
        line: "The draft reads: 'Yesterday the principal ___ the final message at 8:05.'",
        ask: "What is the strongest correction?",
        options: [
          { t: "approved", ok: true, why: "Completed action at a specific time in the past." },
          { t: "approves", ok: false, why: "Present simple conflicts with yesterday marker." },
          { t: "is approving", ok: false, why: "Present continuous conflicts with completed event." },
          { t: "was approve", ok: false, why: "Incorrect past form." }
        ],
        skill: "completed"
      },
      {
        title: "Witness Pair Check",
        line: "Partner A: 'I was checking the board.' Partner B: 'I ___ the attendance list.'",
        ask: "Choose the best parallel line.",
        options: [
          { t: "was reviewing", ok: true, why: "Parallel background action with matching structure." },
          { t: "review", ok: false, why: "Missing auxiliary and -ing form." },
          { t: "am reviewing", ok: false, why: "Present form breaks past scene consistency." },
          { t: "reviewed", ok: false, why: "Shifts from ongoing to completed action." }
        ],
        skill: "parallel"
      },
      {
        title: "Camera Log",
        line: "At 8:03, the class ___ quietly when the microphone failed.",
        ask: "Which option best matches the log style?",
        options: [
          { t: "was reading", ok: true, why: "Ongoing action interrupted by failure event." },
          { t: "read", ok: false, why: "Removes interrupted-action contrast." },
          { t: "reads", ok: false, why: "Present simple does not match past timeline." },
          { t: "is reading", ok: false, why: "Present continuous does not fit past log." }
        ],
        skill: "timeline"
      },
      {
        title: "Teacher Debrief",
        line: "Teacher: 'After we fixed the script, students ___ the corrected version aloud.'",
        ask: "Which line is most accurate?",
        options: [
          { t: "read", ok: true, why: "Completed sequence after fixing event." },
          { t: "were reading", ok: false, why: "Could work in other contexts, but sequence here is completed." },
          { t: "reads", ok: false, why: "Subject-verb mismatch with plural subject in past scene." },
          { t: "are reading", ok: false, why: "Present form conflicts with past event." }
        ],
        skill: "completed"
      },
      {
        title: "Student Reflection",
        line: "'While we ___ the timeline, we found two wrong verb forms.'",
        ask: "What completes the reflection best?",
        options: [
          { t: "were rebuilding", ok: true, why: "While-clause uses ongoing past action." },
          { t: "rebuild", ok: false, why: "Base form does not match while + past context." },
          { t: "are rebuilding", ok: false, why: "Present form conflicts with reflection context." },
          { t: "rebuilt", ok: false, why: "Loses ongoing contrast expected with while." }
        ],
        skill: "timeline"
      },
      {
        title: "Intercom Final Check",
        line: "The assistant said the final script ___ clear and ready.",
        ask: "Which be-verb form fits the report?",
        options: [
          { t: "was", ok: true, why: "Singular subject in past report context." },
          { t: "were", ok: false, why: "Plural form does not match singular subject." },
          { t: "is", ok: false, why: "Present form does not match report context." },
          { t: "are", ok: false, why: "Present plural form is incorrect here." }
        ],
        skill: "agreement"
      },
      {
        title: "Mission Closing",
        line: "By the end of first period, the class ___ the corrected announcement.",
        ask: "Choose the best close-out line.",
        options: [
          { t: "submitted", ok: true, why: "Completed mission action in past timeline." },
          { t: "submits", ok: false, why: "Present simple conflicts with by-the-end marker." },
          { t: "is submitting", ok: false, why: "Present continuous conflicts with completed timeline." },
          { t: "was submitting", ok: false, why: "Ongoing past action is weaker than completed result here." }
        ],
        skill: "completed"
      }
    ];

    const params = new URLSearchParams(location.search);
    const count = Math.max(6, Math.min(20, Number(params.get('count') || 10)));
    const timerOn = (params.get('timer') || 'on') !== 'off';
    const difficulty = (params.get('difficulty') || 'field');

    function accBand(acc){ return acc >= 90 ? 'high' : acc >= 70 ? 'mid' : 'low'; }
    function trackEvent(name, data){
      if (window.GSAnalytics && typeof window.GSAnalytics.track === 'function'){
        window.GSAnalytics.track(name, data || {});
      }
    }

    const sceneTitle = document.getElementById('sceneTitle');
    const sceneLine = document.getElementById('sceneLine');
    const sceneAsk = document.getElementById('sceneAsk');
    const optionsEl = document.getElementById('options');
    const feedbackEl = document.getElementById('feedback');
    const hudProgress = document.getElementById('hudProgress');
    const hudAcc = document.getElementById('hudAcc');
    const hudStreak = document.getElementById('hudStreak');
    const hudTimer = document.getElementById('hudTimer');
    const overlay = document.getElementById('overlay');
    const repAcc = document.getElementById('repAcc');
    const repStrong = document.getElementById('repStrong');
    const repWeak = document.getElementById('repWeak');

    let rounds = [];
    let idx = 0, correct = 0, streak = 0, locked = false;
    let sec = timerOn ? count * 9 : null;
    let timer = null;
    const hits = { completed:0, timeline:0, parallel:0, agreement:0 };

    function pick(){
      rounds = [...BANK].sort(() => Math.random() - 0.5).slice(0, Math.min(count, BANK.length));
      idx = 0; correct = 0; streak = 0; locked = false;
      Object.keys(hits).forEach(k => hits[k] = 0);
      sec = timerOn ? rounds.length * 9 : null;
      if (!timerOn) hudTimer.textContent = 'Off';
    }

    function updateHud(){
      hudProgress.textContent = `${Math.min(idx + 1, rounds.length)}/${rounds.length}`;
      hudAcc.textContent = `${Math.round((correct / Math.max(1, idx)) * 100)}%`;
      hudStreak.textContent = String(streak);
      if (timerOn) hudTimer.textContent = `${Math.max(0, sec)}s`;
    }

    function renderOptions(round){
      optionsEl.innerHTML = '';
      round.options.slice().sort(() => Math.random() - 0.5).forEach((opt, i) => {
        const b = document.createElement('button');
        b.className = 'opt';
        b.type = 'button';
        b.innerHTML = `<b>${String.fromCharCode(65 + i)}</b><span>${opt.t}</span>`;
        b.addEventListener('click', () => choose(opt, round, b));
        optionsEl.appendChild(b);
      });
    }

    function show(){
      if (idx >= rounds.length){ end(); return; }
      locked = false;
      feedbackEl.textContent = '';
      feedbackEl.className = 'feedback';
      const q = rounds[idx];
      sceneTitle.textContent = q.title;
      sceneLine.textContent = q.line;
      sceneAsk.textContent = q.ask;
      renderOptions(q);
      updateHud();
    }

    function choose(opt, round, btn){
      if (locked) return;
      locked = true;
      idx += 1;
      if (opt.ok){
        correct += 1; streak += 1; hits[round.skill] += 1;
        btn.classList.add('good');
        feedbackEl.textContent = `Mission secure: ${opt.why}`;
        feedbackEl.className = 'feedback ok';
      } else {
        streak = 0;
        btn.classList.add('bad');
        const right = round.options.find(o => o.ok);
        feedbackEl.textContent = `Breach detected: ${opt.why} Correct line: "${right.t}".`;
        feedbackEl.className = 'feedback bad';
      }
      updateHud();
      setTimeout(show, 900);
    }

    function end(){
      clearInterval(timer);
      const acc = Math.round((correct / Math.max(1, idx)) * 100);
      const strong = Object.entries(hits).sort((a,b)=>b[1]-a[1])[0][0];
      const weak = Object.entries(hits).sort((a,b)=>a[1]-b[1])[0][0];
      repAcc.textContent = `Accuracy: ${acc}% (${correct}/${Math.max(1, idx)})`;
      repStrong.textContent = `Strong Area: ${strong}`;
      repWeak.textContent = `Vulnerability: ${weak}`;
      trackEvent('mission_complete', { pack:'pack01', module:'G', game:'case-interview', accuracy:acc, accuracyBand:accBand(acc), difficulty, count:rounds.length });
      overlay.classList.add('show');
    }

    function startTimer(){
      if (!timerOn) return;
      clearInterval(timer);
      timer = setInterval(() => {
        sec -= 1;
        hudTimer.textContent = `${Math.max(0, sec)}s`;
        if (sec <= 0) end();
      }, 1000);
    }

    document.getElementById('btnAgain').addEventListener('click', () => {
      trackEvent('replay_click', { pack:'pack01', module:'G', game:'case-interview' });
      overlay.classList.remove('show');
      pick(); show(); startTimer();
    });
    document.getElementById('btnEnd').addEventListener('click', end);

    const howToPlayKey = 'gs_seen_case_interview_guide';
    const howToPlayOverlay = document.getElementById('howToPlayOverlay');
    document.getElementById('btnCloseHowToPlay').addEventListener('click', function(){
      localStorage.setItem(howToPlayKey, '1');
      howToPlayOverlay.style.display = 'none';
      pick(); show(); startTimer();
    });
    if (localStorage.getItem(howToPlayKey) !== '1') {
      howToPlayOverlay.style.display = 'grid';
    } else {
      pick(); show(); startTimer();
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grammar Spy‚Ñ¢ ‚Äî Timeline Clash</title>
  <link rel="icon" type="image/svg+xml" href="../assets/brand/favicon.svg" />
  <link rel="stylesheet" href="../game-ui.css" />
  <style>
    /* Timeline visual */
    .timeline-wrap{position:relative;height:80px;margin:16px 0;background:#f8fafc;border-radius:14px;border:1px solid var(--line);overflow:hidden;padding:12px 20px}
    .timeline-bar{position:absolute;top:36px;left:20px;right:20px;height:8px;background:var(--line);border-radius:4px}
    .timeline-ongoing{position:absolute;top:32px;height:16px;border-radius:8px;background:linear-gradient(90deg,#1f5f63,#2a8a8e);opacity:.6;transition:width .5s ease,left .3s ease}
    .timeline-event{position:absolute;top:22px;width:4px;height:36px;background:var(--gold);border-radius:2px;transition:left .3s ease}
    .timeline-event::after{content:"‚ö°";position:absolute;top:-18px;left:-8px;font-size:16px}
    .timeline-label{position:absolute;bottom:4px;font-size:11px;font-weight:700;color:var(--slate);white-space:nowrap}
    .timeline-label.ongoing{left:20px;color:var(--teal)}
    .timeline-label.event{right:20px;color:var(--gold);text-align:right}

    /* Drag targets */
    .drag-zone{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;min-height:48px;padding:10px;background:#f8fafc;border:2px dashed var(--line);border-radius:12px}
    .drag-zone.active{border-color:var(--teal);background:var(--teal-light)}
    .word-tile{display:inline-flex;align-items:center;padding:8px 16px;background:#fff;border:2px solid var(--line);border-radius:10px;font-size:15px;font-weight:600;cursor:grab;user-select:none;transition:transform .12s,border-color .15s,box-shadow .15s}
    .word-tile:hover{border-color:var(--teal);box-shadow:0 3px 10px rgba(31,95,99,.15);transform:translateY(-2px)}
    .word-tile.placed{opacity:.4;cursor:default}
    .word-tile.correct{border-color:var(--ok);background:var(--ok-bg)}
    .word-tile.wrong{border-color:var(--bad);background:var(--bad-bg)}

    /* Sentence blanks */
    .sentence-build{font-size:18px;line-height:2;color:var(--mid);font-weight:600}
    .blank{display:inline-flex;min-width:100px;padding:4px 12px;border-bottom:3px solid var(--teal);margin:0 4px;font-weight:700;color:var(--teal);cursor:pointer;transition:border-color .15s}
    .blank.filled{border-color:var(--gold);color:var(--mid)}
    .blank.correct-blank{border-color:var(--ok);color:var(--ok)}
    .blank.wrong-blank{border-color:var(--bad);color:var(--bad)}

    /* Scene context */
    .scene-context{background:linear-gradient(135deg,var(--teal-light),#f0f8f9);border:1px solid rgba(31,95,99,.15);border-radius:12px;padding:16px 18px;margin-bottom:12px}
    .scene-context .scene-icon{font-size:24px;margin-right:10px}
    .scene-context .scene-text{font-size:14px;color:var(--slate);line-height:1.5}
    .scene-context .scene-label{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--teal);margin-bottom:4px}

    @media(max-width:700px){.timeline-wrap{height:70px}.word-tile{padding:6px 12px;font-size:13px}}
  </style>
</head>
<body>
<div data-include="header" data-base="../"></div>
<main class="wrap">
  <section class="panel">
    <p class="k" id="packLabel">New Mission ¬∑ Past Tense</p>
    <h1>Timeline Clash</h1>
    <p class="sub">Interrupted actions: figure out what was happening when something else occurred.</p>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressBar" style="width:0%"></div></div>
    <div class="hud">
      <div class="chip"><b>Round</b><span id="hudCase">1/8</span></div>
      <div class="chip"><b>Accuracy</b><span id="hudAcc">0%</span></div>
      <div class="chip"><b>Streak</b><span id="hudStreak">0</span></div>
      <div class="chip"><b>Timer</b><span id="hudTimer">Off</span></div>
    </div>

    <div id="gameArea">
      <div class="scene-context" id="sceneCtx">
        <div class="scene-label" id="sceneLabel">Classroom Scene</div>
        <div><span class="scene-icon" id="sceneIcon">üè´</span><span class="scene-text" id="sceneText"></span></div>
      </div>
      <div class="timeline-wrap" id="timelineWrap">
        <div class="timeline-bar"></div>
        <div class="timeline-ongoing" id="tlOngoing" style="left:20px;width:60%"></div>
        <div class="timeline-event" id="tlEvent" style="left:65%"></div>
        <div class="timeline-label ongoing" id="tlOngoingLabel">was presenting</div>
        <div class="timeline-label event" id="tlEventLabel">alarm rang</div>
      </div>
      <div class="q" id="questionArea">
        <div class="prompt" id="prompt">Choose the correct sentence:</div>
        <div class="opts" id="opts"></div>
      </div>
    </div>
    <p class="feedback" id="feedback"></p>
    <div class="row">
      <button class="btn" id="endBtn" type="button">End Mission</button>
      <button class="btn" id="hintBtn" type="button">Hint (2 left)</button>
      <button class="btn" id="btnSound" type="button">Sound: ON</button>
      <a class="btn" href="../index.html">Home</a>
    </div>
  </section>
</main>

<!-- Onboarding -->
<div id="onboardOverlay" class="overlay show" role="dialog" aria-modal="true">
  <section class="modal" style="max-width:540px">
    <div class="onboard-difficulty diff-field" id="diffBadge">Field Agent</div>
    <h2 class="onboard-title">Timeline Clash</h2>
    <p class="onboard-subtitle">When two actions collide in time ‚Äî one ongoing, one sudden ‚Äî which tense goes where?</p>
    <div class="onboard-steps">
      <div class="onboard-step">
        <div class="onboard-step-num">1</div>
        <div class="onboard-step-text"><strong>Read the scene.</strong> A short classroom or real-life moment. Something was happening, then something interrupted it.</div>
      </div>
      <div class="onboard-step">
        <div class="onboard-step-num">2</div>
        <div class="onboard-step-text"><strong>Watch the timeline.</strong> The teal bar shows the ongoing action. The gold marker shows the interruption point.</div>
      </div>
      <div class="onboard-step">
        <div class="onboard-step-num">3</div>
        <div class="onboard-step-text"><strong>Pick or build the sentence</strong> that uses the right verb forms. Past continuous for the ongoing action, past simple for the interruption.</div>
      </div>
    </div>
    <div class="onboard-tip">
      <span class="onboard-tip-icon">üí°</span>
      <span><strong>Key rule:</strong> "was/were + -ing" for the background action. Simple past (walked, rang, called) for the interruption.</span>
    </div>
    <button class="onboard-start" id="startBtn" type="button">Start Mission</button>
  </section>
</div>

<!-- Mission Report -->
<div class="overlay" id="reportOverlay">
  <section class="modal">
    <h2 style="margin:0">Mission Report</h2>
    <p id="reportAcc"></p>
    <p id="reportScore"></p>
    <p id="reportRec"></p>
    <div class="box" id="reportInsight"></div>
    <div class="row" style="margin-top:14px">
      <button class="btn primary" id="replayBtn" type="button">Play Again</button>
      <a class="btn" href="../index.html">Home</a>
    </div>
  </section>
</div>

<div data-include="footer" data-base="../"></div>
<script src="../billing-scaffold.js"></script>
<script src="../auth-scaffold.js"></script>
<script src="../layout-loader.js"></script>
<script src="../app-shell.js"></script>
<script src="../game-sound.js"></script>
<script src="../gs-animations.js"></script>
<script>
(function(){
  // ‚îÄ‚îÄ Item Bank ‚îÄ‚îÄ
  var ITEMS = [
    // Rookie (pre-labeled timeline, pick correct sentence)
    {id:"r1",scene:"Fire drill during a presentation",icon:"üîî",context:"Maya was showing her project to the class.",ongoing:"was presenting",event:"alarm rang",
     prompt:"What happened?",
     options:["Maya was presenting when the fire alarm rang.","Maya presented when the fire alarm was ringing.","Maya presents when the fire alarm rang.","Maya was presenting when the fire alarm was ringing."],
     answer:0,explain:"Past continuous (was presenting) for the ongoing action; past simple (rang) for the sudden interruption.",level:"rookie",tags:["interrupted_action"]},
    {id:"r2",scene:"Phone call during dinner",icon:"üì±",context:"The family was eating dinner together.",ongoing:"were eating",event:"phone rang",
     prompt:"Choose the correct sentence:",
     options:["They were eating dinner when the phone rang.","They ate dinner when the phone was ringing.","They were eating dinner when the phone was ringing.","They eat dinner when the phone rang."],
     answer:0,explain:"Were eating = ongoing background action. Rang = sudden interruption. Use past continuous + past simple.",level:"rookie",tags:["interrupted_action"]},
    {id:"r3",scene:"Rain during a soccer game",icon:"‚öΩ",context:"The students were playing soccer on the field.",ongoing:"were playing",event:"rain started",
     prompt:"Choose the correct sentence:",
     options:["The students played soccer when it was starting to rain.","The students were playing soccer when it started to rain.","The students were playing soccer when it was starting to rain.","The students play soccer when it started to rain."],
     answer:1,explain:"Were playing = ongoing action. Started = sudden change. Past continuous for background, past simple for interruption.",level:"rookie",tags:["interrupted_action"]},
    {id:"r4",scene:"Teacher walked in during a chat",icon:"üè´",context:"The students were talking loudly in class.",ongoing:"were talking",event:"teacher walked in",
     prompt:"Choose the correct sentence:",
     options:["The students talked when the teacher was walking in.","The students were talking when the teacher walked in.","The students were talking when the teacher was walking in.","The students talk when the teacher walked in."],
     answer:1,explain:"Were talking = ongoing action in progress. Walked in = sudden, completed interruption.",level:"rookie",tags:["interrupted_action"]},
    // Field Agent (drag verb forms into blanks)
    {id:"f1",scene:"Power outage during a test",icon:"üí°",context:"The class was taking a science test when the lights suddenly went out.",ongoing:"was taking",event:"went out",
     prompt:"Fill in the blanks:",
     sentence:"The class ___ a science test when the lights suddenly ___ out.",
     blanks:["was taking","went"],distractors:["took","were going","takes","was going"],
     explain:"Was taking = ongoing test (past continuous). Went = sudden outage (past simple).",level:"field",tags:["interrupted_action"]},
    {id:"f2",scene:"Message during class work",icon:"üí¨",context:"Sarah was writing her essay when she received a text message.",ongoing:"was writing",event:"received",
     prompt:"Fill in the blanks:",
     sentence:"Sarah ___ her essay when she ___ a text message.",
     blanks:["was writing","received"],distractors:["wrote","was receiving","writes","receiving"],
     explain:"Was writing = ongoing task. Received = sudden moment of getting the message.",level:"field",tags:["interrupted_action"]},
    {id:"f3",scene:"Announcement during lunch",icon:"üì¢",context:"Everyone was eating in the cafeteria when the principal made an announcement.",ongoing:"was eating",event:"made",
     prompt:"Fill in the blanks:",
     sentence:"Everyone ___ in the cafeteria when the principal ___ an announcement.",
     blanks:["was eating","made"],distractors:["ate","was making","eats","were making"],
     explain:"Was eating = ongoing lunch activity. Made = single completed action of announcing.",level:"field",tags:["interrupted_action"]},
    {id:"f4",scene:"Dog ran in during rehearsal",icon:"üé≠",context:"The drama club was rehearsing the play when a dog ran onto the stage.",ongoing:"was rehearsing",event:"ran",
     prompt:"Fill in the blanks:",
     sentence:"The drama club ___ the play when a dog ___ onto the stage.",
     blanks:["was rehearsing","ran"],distractors:["rehearsed","was running","rehearses","were running"],
     explain:"Was rehearsing = ongoing rehearsal. Ran = sudden, unexpected interruption.",level:"field",tags:["interrupted_action"]},
    // Director (build from word tiles)
    {id:"d1",scene:"Earthquake during a lesson",icon:"üåç",context:"Mr. Chen was explaining fractions when the ground started shaking.",ongoing:"was explaining",event:"started shaking",
     prompt:"Build the sentence using the correct verb forms:",
     words:["Mr. Chen","was explaining","fractions","when","the ground","started","shaking"],
     correctOrder:"Mr. Chen was explaining fractions when the ground started shaking.",
     explain:"Was explaining = ongoing teaching. Started shaking = sudden natural event interrupting.",level:"director",tags:["interrupted_action"]},
    {id:"d2",scene:"Bell rang during group work",icon:"üîî",context:"The students were working in groups when the bell rang.",ongoing:"were working",event:"rang",
     prompt:"Build the sentence using the correct verb forms:",
     words:["The students","were working","in groups","when","the bell","rang"],
     correctOrder:"The students were working in groups when the bell rang.",
     explain:"Were working = ongoing group activity. Rang = sudden event ending the activity.",level:"director",tags:["interrupted_action"]},
    {id:"d3",scene:"Spill during an experiment",icon:"üî¨",context:"Elena was measuring chemicals when she accidentally spilled the solution.",ongoing:"was measuring",event:"spilled",
     prompt:"Build the sentence using the correct verb forms:",
     words:["Elena","was measuring","chemicals","when","she accidentally","spilled","the solution"],
     correctOrder:"Elena was measuring chemicals when she accidentally spilled the solution.",
     explain:"Was measuring = careful ongoing action. Spilled = sudden accidental interruption.",level:"director",tags:["interrupted_action"]},
    {id:"d4",scene:"Visitor arrived during PE",icon:"üèÉ",context:"The class was running laps when a visitor arrived at the gym.",ongoing:"was running",event:"arrived",
     prompt:"Build the sentence using the correct verb forms:",
     words:["The class","was running","laps","when","a visitor","arrived","at the gym"],
     correctOrder:"The class was running laps when a visitor arrived at the gym.",
     explain:"Was running = ongoing PE activity. Arrived = completed action of showing up.",level:"director",tags:["interrupted_action"]}
  ];

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  var q = new URLSearchParams(location.search);
  var difficulty = q.get('difficulty') || 'field';
  var count = Math.max(4, Math.min(12, Number(q.get('count') || 8)));
  var timerOn = (q.get('timer') || 'off') !== 'off';
  var rounds = [], idx = 0, correct = 0, streak = 0, score = 0, locked = false, hints = 2;

  // ‚îÄ‚îÄ DOM ‚îÄ‚îÄ
  var hudCase = document.getElementById('hudCase');
  var hudAcc = document.getElementById('hudAcc');
  var hudStreak = document.getElementById('hudStreak');
  var hudTimer = document.getElementById('hudTimer');
  var progressBar = document.getElementById('progressBar');
  var feedback = document.getElementById('feedback');
  var opts = document.getElementById('opts');
  var prompt = document.getElementById('prompt');
  var sceneText = document.getElementById('sceneText');
  var sceneIcon = document.getElementById('sceneIcon');
  var sceneLabel = document.getElementById('sceneLabel');
  var tlOngoing = document.getElementById('tlOngoing');
  var tlEvent = document.getElementById('tlEvent');
  var tlOngoingLabel = document.getElementById('tlOngoingLabel');
  var tlEventLabel = document.getElementById('tlEventLabel');

  // ‚îÄ‚îÄ Difficulty badge ‚îÄ‚îÄ
  var badge = document.getElementById('diffBadge');
  if (badge) {
    badge.className = 'onboard-difficulty diff-' + difficulty;
    badge.textContent = difficulty === 'rookie' ? 'Rookie' : difficulty === 'director' ? 'Director' : 'Field Agent';
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  function shuffle(arr) { var a = arr.slice(); for (var i = a.length - 1; i > 0; i--) { var j = Math.floor(Math.random() * (i + 1)); var t = a[i]; a[i] = a[j]; a[j] = t; } return a; }

  function buildRounds() {
    var pool = ITEMS.filter(function(item) { return item.level === difficulty; });
    if (!pool.length) pool = ITEMS.filter(function(item) { return item.level === 'rookie'; });
    rounds = shuffle(pool).slice(0, Math.min(count, pool.length));
  }

  function updateHud() {
    hudCase.textContent = Math.min(idx + 1, rounds.length) + '/' + rounds.length;
    hudAcc.textContent = Math.round((correct / Math.max(1, idx)) * 100) + '%';
    hudStreak.textContent = String(streak);
    hudTimer.textContent = timerOn ? 'On' : 'Off';
    progressBar.style.width = Math.round((idx / Math.max(1, rounds.length)) * 100) + '%';
  }

  function showFeedback(isCorrect, explain) {
    if (isCorrect) {
      feedback.innerHTML = '<span class="ok"><b>Correct!</b> ' + explain + '</span>';
      if (window.GSSound && window.GSSound.correct) window.GSSound.correct();
    } else {
      feedback.innerHTML = '<span class="bad"><b>Not quite.</b> ' + explain + '</span>';
      if (window.GSSound && window.GSSound.wrong) window.GSSound.wrong();
    }
  }

  // ‚îÄ‚îÄ Render round ‚îÄ‚îÄ
  function showRound() {
    if (idx >= rounds.length) { endGame(); return; }
    locked = false;
    feedback.textContent = '';
    var item = rounds[idx];
    sceneText.textContent = item.context;
    sceneIcon.textContent = item.icon;
    sceneLabel.textContent = item.scene;
    tlOngoingLabel.textContent = item.ongoing;
    tlEventLabel.textContent = item.event;

    if (difficulty === 'rookie' || item.options) {
      renderChoiceMode(item);
    } else if (difficulty === 'field' && item.blanks) {
      renderFillMode(item);
    } else if (difficulty === 'director' && item.words) {
      renderBuildMode(item);
    } else {
      renderChoiceMode(item);
    }
    updateHud();
  }

  // ‚îÄ‚îÄ Choice mode (Rookie) ‚îÄ‚îÄ
  function renderChoiceMode(item) {
    prompt.textContent = item.prompt;
    opts.style.gridTemplateColumns = '1fr';
    opts.innerHTML = '';
    var labels = 'ABCD';
    shuffle(item.options.map(function(t, i) { return {t:t, i:i}; })).forEach(function(o, li) {
      var btn = document.createElement('button');
      btn.className = 'opt';
      btn.type = 'button';
      btn.textContent = o.t;
      btn.setAttribute('data-label', labels[li]);
      btn.addEventListener('click', function() {
        if (locked) return;
        locked = true;
        idx++;
        var isCorrect = o.i === item.answer;
        if (isCorrect) { correct++; streak++; score += 100; btn.classList.add('good'); }
        else { streak = 0; btn.classList.add('bad'); }
        showFeedback(isCorrect, item.explain);
        setTimeout(showRound, 1200);
      });
      opts.appendChild(btn);
    });
  }

  // ‚îÄ‚îÄ Fill mode (Field Agent) ‚îÄ‚îÄ
  function renderFillMode(item) {
    prompt.textContent = item.prompt;
    opts.innerHTML = '';
    var parts = item.sentence.split('___');
    var filledBlanks = [];
    var blanksNeeded = item.blanks.length;

    var sentenceDiv = document.createElement('div');
    sentenceDiv.className = 'sentence-build';
    parts.forEach(function(part, i) {
      sentenceDiv.appendChild(document.createTextNode(part));
      if (i < blanksNeeded) {
        var blankEl = document.createElement('span');
        blankEl.className = 'blank';
        blankEl.textContent = '___';
        blankEl.dataset.idx = i;
        sentenceDiv.appendChild(blankEl);
        filledBlanks.push(null);
      }
    });
    opts.appendChild(sentenceDiv);

    var tileZone = document.createElement('div');
    tileZone.className = 'drag-zone';
    var allTiles = shuffle(item.blanks.concat(item.distractors));
    allTiles.forEach(function(word) {
      var tile = document.createElement('button');
      tile.className = 'word-tile';
      tile.type = 'button';
      tile.textContent = word;
      tile.addEventListener('click', function() {
        if (locked || tile.classList.contains('placed')) return;
        var nextBlank = filledBlanks.indexOf(null);
        if (nextBlank < 0) return;
        filledBlanks[nextBlank] = word;
        tile.classList.add('placed');
        var blankEl = sentenceDiv.querySelector('[data-idx="' + nextBlank + '"]');
        if (blankEl) { blankEl.textContent = word; blankEl.classList.add('filled'); }
        if (filledBlanks.indexOf(null) < 0) checkFillAnswer(item, filledBlanks, sentenceDiv);
      });
      tileZone.appendChild(tile);
    });
    opts.appendChild(tileZone);
  }

  function checkFillAnswer(item, filled, sentenceDiv) {
    locked = true;
    idx++;
    var allCorrect = true;
    for (var i = 0; i < item.blanks.length; i++) {
      var blankEl = sentenceDiv.querySelector('[data-idx="' + i + '"]');
      if (filled[i] === item.blanks[i]) {
        if (blankEl) blankEl.classList.add('correct-blank');
      } else {
        allCorrect = false;
        if (blankEl) blankEl.classList.add('wrong-blank');
      }
    }
    if (allCorrect) { correct++; streak++; score += 100; }
    else { streak = 0; }
    showFeedback(allCorrect, item.explain);
    setTimeout(showRound, 1800);
  }

  // ‚îÄ‚îÄ Build mode (Director) ‚îÄ‚îÄ
  function renderBuildMode(item) {
    prompt.textContent = item.prompt;
    opts.innerHTML = '';
    var placed = [];

    var buildArea = document.createElement('div');
    buildArea.className = 'drag-zone active';
    buildArea.style.minHeight = '56px';
    buildArea.id = 'buildArea';
    opts.appendChild(buildArea);

    var tileZone = document.createElement('div');
    tileZone.className = 'drag-zone';
    shuffle(item.words).forEach(function(word) {
      var tile = document.createElement('button');
      tile.className = 'word-tile';
      tile.type = 'button';
      tile.textContent = word;
      tile.addEventListener('click', function() {
        if (locked) return;
        if (tile.classList.contains('placed')) {
          tile.classList.remove('placed');
          placed = placed.filter(function(w) { return w !== word; });
          tileZone.appendChild(tile);
        } else {
          tile.classList.add('placed');
          placed.push(word);
          buildArea.appendChild(tile);
        }
      });
      tileZone.appendChild(tile);
    });
    opts.appendChild(tileZone);

    var submitBtn = document.createElement('button');
    submitBtn.className = 'btn primary';
    submitBtn.type = 'button';
    submitBtn.textContent = 'Submit Sentence';
    submitBtn.style.marginTop = '10px';
    submitBtn.addEventListener('click', function() {
      if (locked) return;
      locked = true;
      idx++;
      var built = placed.join(' ');
      var isCorrect = built.toLowerCase().replace(/[.,!?]/g,'').trim() === item.correctOrder.toLowerCase().replace(/[.,!?]/g,'').trim();
      if (isCorrect) { correct++; streak++; score += 150; }
      else { streak = 0; }
      showFeedback(isCorrect, (isCorrect ? '' : 'The correct sentence is: "' + item.correctOrder + '". ') + item.explain);
      setTimeout(showRound, 2000);
    });
    opts.appendChild(submitBtn);
  }

  // ‚îÄ‚îÄ End Game ‚îÄ‚îÄ
  function endGame() {
    var acc = Math.round((correct / Math.max(1, idx)) * 100);
    document.getElementById('reportAcc').textContent = 'Accuracy: ' + acc + '% (' + correct + '/' + idx + ')';
    document.getElementById('reportScore').textContent = 'Score: ' + score + ' pts';
    document.getElementById('reportRec').textContent = acc >= 80 ? 'Recommendation: Advance to the next difficulty!' : 'Recommendation: Replay to strengthen your timeline skills.';
    document.getElementById('reportInsight').innerHTML = '<div class="skill-label" style="color:var(--teal)">GRAMMAR INSIGHT</div>' +
      '<p style="margin:6px 0 0;font-size:13px;line-height:1.6">Past Continuous (was/were + -ing) describes the <strong>ongoing background action</strong>. Past Simple describes the <strong>sudden interruption</strong>. They work together to show two actions colliding in time.</p>';
    document.getElementById('reportOverlay').classList.add('show');
    if (window.GSSound && window.GSSound.missionComplete) window.GSSound.missionComplete();
  }

  // ‚îÄ‚îÄ Hint ‚îÄ‚îÄ
  document.getElementById('hintBtn').addEventListener('click', function() {
    if (hints <= 0 || locked) return;
    hints--;
    document.getElementById('hintBtn').textContent = 'Hint (' + hints + ' left)';
    score = Math.max(0, score - 30);
    var item = rounds[idx];
    if (item) {
      feedback.innerHTML = '<span class="ok">üí° Hint: The ongoing action uses <strong>was/were + -ing</strong>. The interruption uses <strong>simple past</strong>.</span>';
    }
  });

  // ‚îÄ‚îÄ Start ‚îÄ‚îÄ
  document.getElementById('startBtn').addEventListener('click', function() {
    document.getElementById('onboardOverlay').classList.remove('show');
    buildRounds();
    showRound();
  });
  document.getElementById('endBtn').addEventListener('click', function() { idx = rounds.length; endGame(); });
  document.getElementById('replayBtn').addEventListener('click', function() {
    document.getElementById('reportOverlay').classList.remove('show');
    idx = 0; correct = 0; streak = 0; score = 0; hints = 2;
    document.getElementById('hintBtn').textContent = 'Hint (2 left)';
    buildRounds();
    showRound();
  });

  if (!timerOn) hudTimer.textContent = 'Off';
})();
</script>
</body>
</html>

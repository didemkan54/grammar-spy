<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grammar Spy‚Ñ¢ ‚Äî Article Scanner</title>
  <link rel="icon" type="image/svg+xml" href="../assets/brand/favicon.svg" />
  <link rel="stylesheet" href="../game-ui.css" />
  <style>
    /* Scene context */
    .scene-context{background:linear-gradient(135deg,var(--teal-light),#f0f8f9);border:1px solid rgba(31,95,99,.15);border-radius:12px;padding:16px 18px;margin-bottom:12px}
    .scene-context .scene-icon{font-size:24px;margin-right:10px}
    .scene-context .scene-text{font-size:14px;color:var(--slate);line-height:1.5}
    .scene-context .scene-label{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--teal);margin-bottom:4px}

    /* Sentence display */
    .sentence-display{font-size:19px;line-height:2;color:var(--mid);font-weight:600;padding:14px 0;text-align:center}
    .blank-slot{display:inline-flex;min-width:60px;padding:4px 12px;border-bottom:3px solid var(--gold);margin:0 3px;font-weight:800;color:var(--gold);cursor:pointer;justify-content:center;border-radius:4px;transition:border-color .15s,background .15s}
    .blank-slot.active{border-color:var(--teal);background:var(--teal-light);color:var(--teal)}
    .blank-slot.filled{border-color:var(--mid);color:var(--mid);background:#f8fafc}
    .blank-slot.correct-fill{border-color:var(--ok);color:var(--ok);background:var(--ok-bg)}
    .blank-slot.wrong-fill{border-color:var(--bad);color:var(--bad);background:var(--bad-bg)}

    /* Specificity Meter */
    .meter-wrap{margin:16px 0;padding:14px;background:#f8fafc;border:1px solid var(--line);border-radius:12px}
    .meter-label{display:flex;justify-content:space-between;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--slate);margin-bottom:6px}
    .meter-track{position:relative;height:28px;background:linear-gradient(90deg,#e8f4f5 0%,#fdf6e3 50%,#1f5f63 100%);border-radius:14px;cursor:pointer;overflow:visible}
    .meter-track.disabled{cursor:default;opacity:.7}
    .meter-thumb{position:absolute;top:-2px;width:32px;height:32px;background:#fff;border:3px solid var(--teal);border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.15);transition:left .25s ease;transform:translateX(-50%)}
    .meter-thumb.hint{border-color:var(--gold);box-shadow:0 0 10px rgba(201,162,39,.3)}
    .meter-zone{position:absolute;top:0;height:100%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:rgba(0,0,0,.35);pointer-events:none}

    /* Article buttons */
    .article-choices{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:12px 0}
    .article-btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 32px;background:#fff;border:2px solid var(--line);border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;transition:border-color .15s,background .15s,transform .12s,box-shadow .15s;color:var(--mid);min-width:72px}
    .article-btn:hover{border-color:var(--teal);background:var(--teal-light);transform:translateY(-2px);box-shadow:0 3px 10px rgba(31,95,99,.12)}
    .article-btn.correct{border-color:var(--ok);background:var(--ok-bg);color:var(--ok)}
    .article-btn.wrong{border-color:var(--bad);background:var(--bad-bg);color:var(--bad)}
    .article-btn:disabled{opacity:.5;cursor:default;transform:none}

    /* Instruction */
    .game-instruction{text-align:center;font-size:13px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.08em;margin:8px 0;padding:8px 14px;background:var(--teal-light);border-radius:8px}

    /* Director paragraph */
    .director-para{font-size:17px;line-height:2.2;color:var(--mid);font-weight:600;padding:10px 0}
    .director-submit{margin-top:10px}

    @media(max-width:700px){.sentence-display{font-size:16px}.article-btn{padding:10px 22px;font-size:16px}}
  </style>
</head>
<body>
<div data-include="header" data-base="../"></div>
<main class="wrap">
  <section class="panel">
    <p class="k" id="packLabel">New Mission ¬∑ Articles</p>
    <h1>Article Scanner</h1>
    <p class="sub">a, an, the, or nothing? Scan the context and pick the right article for every noun.</p>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressBar" style="width:0%"></div></div>
    <div class="hud">
      <div class="chip"><b>Round</b><span id="hudCase">1/4</span></div>
      <div class="chip"><b>Accuracy</b><span id="hudAcc">0%</span></div>
      <div class="chip"><b>Streak</b><span id="hudStreak">0</span></div>
      <div class="chip"><b>Timer</b><span id="hudTimer">Off</span></div>
    </div>

    <div id="gameArea">
      <div class="scene-context" id="sceneCtx">
        <div class="scene-label" id="sceneLabel">Cafeteria Menu</div>
        <div><span class="scene-icon" id="sceneIcon">üçΩÔ∏è</span><span class="scene-text" id="sceneText"></span></div>
      </div>
      <div class="game-instruction" id="instruction"></div>
      <div id="meterArea"></div>
      <div class="sentence-display" id="sentenceDisplay"></div>
      <div class="article-choices" id="articleChoices"></div>
    </div>
    <p class="feedback" id="feedback"></p>
    <div class="row">
      <button class="btn" id="endBtn" type="button">End Mission</button>
      <button class="btn" id="hintBtn" type="button">Hint (2 left)</button>
      <button class="btn" id="btnSound" type="button">Sound: ON</button>
      <a class="btn" href="../index.html">Home</a>
    </div>
  </section>
</main>

<!-- Onboarding -->
<div id="onboardOverlay" class="overlay show" role="dialog" aria-modal="true">
  <section class="modal" style="max-width:540px">
    <div class="onboard-difficulty diff-field" id="diffBadge">Field Agent</div>
    <h2 class="onboard-title">Article Scanner</h2>
    <p class="onboard-subtitle">Articles seem small, but choosing a, an, the, or nothing changes meaning entirely. Scan context clues to pick the right one.</p>
    <div class="onboard-steps">
      <div class="onboard-step">
        <div class="onboard-step-num">1</div>
        <div class="onboard-step-text"><strong>Read the context card.</strong> It might be a cafeteria menu, school announcement, lab instruction, or text message ‚Äî each gives clues about specificity.</div>
      </div>
      <div class="onboard-step">
        <div class="onboard-step-num">2</div>
        <div class="onboard-step-text"><strong>Check the specificity meter.</strong> The gradient runs from "Any/General" on the left to "The Specific One" on the right. Use it to decide the article.</div>
      </div>
      <div class="onboard-step">
        <div class="onboard-step-num">3</div>
        <div class="onboard-step-text"><strong>Pick the article</strong> (a, an, the, or √ò for no article) that fits the blank. Feedback tells you the noun category and grammar rule.</div>
      </div>
    </div>
    <div class="onboard-tip">
      <span class="onboard-tip-icon">üí°</span>
      <span><strong>Key rules:</strong> "a/an" = first mention, any one. "the" = specific, known to both. "√ò" = general plurals or uncountable nouns.</span>
    </div>
    <button class="onboard-start" id="startBtn" type="button">Start Mission</button>
  </section>
</div>

<!-- Mission Report -->
<div class="overlay" id="reportOverlay">
  <section class="modal">
    <h2 style="margin:0">Mission Report</h2>
    <p id="reportAcc"></p>
    <p id="reportScore"></p>
    <p id="reportRec"></p>
    <div class="box" id="reportInsight"></div>
    <div class="row" style="margin-top:14px">
      <button class="btn primary" id="replayBtn" type="button">Play Again</button>
      <a class="btn" href="../index.html">Home</a>
    </div>
  </section>
</div>

<div data-include="footer" data-base="../"></div>
<script src="../billing-scaffold.js"></script>
<script src="../auth-scaffold.js"></script>
<script src="../layout-loader.js"></script>
<script src="../app-shell.js"></script>
<script src="../game-sound.js"></script>
<script src="../gs-animations.js"></script>
<script>
(function(){
  // ‚îÄ‚îÄ Item Bank ‚îÄ‚îÄ
  var ITEMS = [
    // Rookie (meter pre-positioned, pick article)
    {id:"r1",scene:"Cafeteria Menu",icon:"üçΩÔ∏è",context:"Today's lunch special is new. Nobody has seen it before.",
     sentence:"Would you like to try ___ new sandwich?",noun:"sandwich",nounType:"countable, first mention, singular",
     options:["a","an","the","√ò"],answer:"a",meterPos:20,
     explain:"\"Sandwich\" is countable and singular. This is the first time it's mentioned (new item) ‚Üí use \"a.\"",
     level:"rookie",tags:["first_mention"]},
    {id:"r2",scene:"School Announcement",icon:"üì¢",context:"Everyone knows which auditorium the school has ‚Äî there's only one.",
     sentence:"All students must report to ___ auditorium by 9 AM.",noun:"auditorium",nounType:"countable, known/specific",
     options:["a","an","the","√ò"],answer:"the",meterPos:85,
     explain:"The auditorium is specific and known to everyone at the school ‚Üí use \"the.\"",
     level:"rookie",tags:["specific_reference"]},
    {id:"r3",scene:"Text Message",icon:"üí¨",context:"Your friend is talking about food in general, no specific items.",
     sentence:"I love ___ pizza!",noun:"pizza",nounType:"uncountable, general reference",
     options:["a","an","the","√ò"],answer:"√ò",meterPos:5,
     explain:"\"Pizza\" here refers to pizza in general (not a specific pizza). General uncountable ‚Üí no article (√ò).",
     level:"rookie",tags:["general_uncountable"]},
    {id:"r4",scene:"Lab Instruction",icon:"üî¨",context:"Your teacher hands you a piece of equipment you haven't used before.",
     sentence:"Please pick up ___ eraser from the supply shelf.",noun:"eraser",nounType:"countable, first mention, starts with vowel sound",
     options:["a","an","the","√ò"],answer:"an",meterPos:25,
     explain:"\"Eraser\" starts with a vowel sound and this is any eraser (first mention, not specific) ‚Üí use \"an.\"",
     level:"rookie",tags:["a_vs_an"]},

    // Field Agent (position meter first, then choose article)
    {id:"f1",scene:"Cafeteria Line",icon:"ü•§",context:"You're at the drink station. There are many juice boxes.",
     sentence:"Can I have ___ juice box, please?",noun:"juice box",nounType:"countable, first mention, any one",
     options:["a","an","the","√ò"],answer:"a",meterPos:20,
     explain:"You're requesting any one juice box, not a specific one. First mention, countable, singular ‚Üí \"a.\"",
     level:"field",tags:["first_mention"]},
    {id:"f2",scene:"School Newsletter",icon:"üì∞",context:"The principal sent a letter last week. Now there's a follow-up.",
     sentence:"___ letter from the principal included important updates.",noun:"letter",nounType:"countable, second mention, specific",
     options:["A","An","The","√ò"],answer:"The",meterPos:80,
     explain:"\"The letter\" refers to a specific letter already known from last week (second mention) ‚Üí \"The.\"",
     level:"field",tags:["second_mention"]},
    {id:"f3",scene:"Class Discussion",icon:"üó£Ô∏è",context:"The teacher is talking about traits that all humans share.",
     sentence:"___ honesty is an important value.",noun:"honesty",nounType:"uncountable, abstract, general concept",
     options:["A","An","The","√ò"],answer:"√ò",meterPos:5,
     explain:"\"Honesty\" is an abstract uncountable noun used in a general sense ‚Üí no article needed (√ò).",
     level:"field",tags:["general_uncountable"]},
    {id:"f4",scene:"Lab Safety Poster",icon:"‚öóÔ∏è",context:"A poster on the wall lists things students must wear. Everyone can see them on the shelf.",
     sentence:"Put on ___ safety goggles before starting the experiment.",noun:"safety goggles",nounType:"countable plural, specific set known to all",
     options:["a","an","the","√ò"],answer:"the",meterPos:82,
     explain:"\"The safety goggles\" refers to the specific ones on the shelf that everyone knows about ‚Üí \"the.\"",
     level:"field",tags:["specific_reference"]},

    // Director (fill in 3 blanks in a paragraph)
    {id:"d1",scene:"Morning Announcement",icon:"üì¢",context:"The vice-principal reads announcements every morning.",
     paragraph:"Good morning! We have {1} exciting announcement today. {2} annual science fair will be held next Friday. Please bring {3} permission slip to your homeroom teacher.",
     blanks:[{pos:1,answer:"an",noun:"announcement",nounType:"countable, first mention, vowel sound"},{pos:2,answer:"The",noun:"science fair",nounType:"countable, known event"},{pos:3,answer:"a",noun:"permission slip",nounType:"countable, first mention, any one"}],
     explain:"\"An\" for first-mention vowel-sound noun. \"The\" for the known annual event. \"A\" for any one permission slip (first mention).",
     level:"director",tags:["mixed_articles"]},
    {id:"d2",scene:"Cafeteria Rules",icon:"üçΩÔ∏è",context:"New signs posted in the cafeteria this semester.",
     paragraph:"Students must return {1} trays after eating. {2} new recycling bin is next to {3} exit door on the right.",
     blanks:[{pos:1,answer:"√ò",noun:"trays",nounType:"countable plural, general rule"},{pos:2,answer:"A",noun:"recycling bin",nounType:"countable, first mention"},{pos:3,answer:"the",noun:"exit door",nounType:"countable, specific one"}],
     explain:"\"√ò\" for general rule about all trays. \"A\" introduces the new bin (first mention). \"The\" for the specific exit door.",
     level:"director",tags:["mixed_articles"]},
    {id:"d3",scene:"Text Conversation",icon:"üí¨",context:"Two friends texting about plans after school.",
     paragraph:"Hey! Want to go to {1} park after school? I heard {2} ice cream truck comes there on Fridays. I love {3} ice cream!",
     blanks:[{pos:1,answer:"the",noun:"park",nounType:"countable, specific known park"},{pos:2,answer:"an",noun:"ice cream truck",nounType:"countable, first mention, vowel sound"},{pos:3,answer:"√ò",noun:"ice cream",nounType:"uncountable, general"}],
     explain:"\"The\" park both friends know. \"An\" for a truck mentioned for the first time (vowel sound). \"√ò\" for ice cream in general.",
     level:"director",tags:["mixed_articles"]},
    {id:"d4",scene:"Lab Report",icon:"üî¨",context:"A student writing up their experiment results.",
     paragraph:"We tested {1} hypothesis about plant growth. {2} results showed that {3} sunlight is essential for photosynthesis.",
     blanks:[{pos:1,answer:"a",noun:"hypothesis",nounType:"countable, first mention"},{pos:2,answer:"The",noun:"results",nounType:"countable plural, specific to this experiment"},{pos:3,answer:"√ò",noun:"sunlight",nounType:"uncountable, general"}],
     explain:"\"A\" introduces the hypothesis (first mention). \"The\" for the specific results of this experiment. \"√ò\" for sunlight as a general concept.",
     level:"director",tags:["mixed_articles"]}
  ];

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  var q = new URLSearchParams(location.search);
  var difficulty = q.get('difficulty') || 'field';
  var count = Math.max(4, Math.min(12, Number(q.get('count') || 4)));
  var timerOn = (q.get('timer') || 'off') !== 'off';
  var rounds = [], idx = 0, correct = 0, streak = 0, score = 0, locked = false, hints = 2;
  var meterReady = false;

  // ‚îÄ‚îÄ DOM ‚îÄ‚îÄ
  var hudCase = document.getElementById('hudCase');
  var hudAcc = document.getElementById('hudAcc');
  var hudStreak = document.getElementById('hudStreak');
  var hudTimer = document.getElementById('hudTimer');
  var progressBar = document.getElementById('progressBar');
  var feedback = document.getElementById('feedback');
  var sentenceDisplay = document.getElementById('sentenceDisplay');
  var articleChoices = document.getElementById('articleChoices');
  var instruction = document.getElementById('instruction');
  var sceneText = document.getElementById('sceneText');
  var sceneIcon = document.getElementById('sceneIcon');
  var sceneLabel = document.getElementById('sceneLabel');
  var meterArea = document.getElementById('meterArea');

  // ‚îÄ‚îÄ Difficulty badge ‚îÄ‚îÄ
  var badge = document.getElementById('diffBadge');
  if (badge) {
    badge.className = 'onboard-difficulty diff-' + difficulty;
    badge.textContent = difficulty === 'rookie' ? 'Rookie' : difficulty === 'director' ? 'Director' : 'Field Agent';
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function shuffle(arr) { var a = arr.slice(); for (var i = a.length - 1; i > 0; i--) { var j = Math.floor(Math.random() * (i + 1)); var t = a[i]; a[i] = a[j]; a[j] = t; } return a; }

  function buildRounds() {
    var pool = ITEMS.filter(function(item) { return item.level === difficulty; });
    if (!pool.length) pool = ITEMS.filter(function(item) { return item.level === 'rookie'; });
    rounds = shuffle(pool).slice(0, Math.min(count, pool.length));
  }

  function updateHud() {
    hudCase.textContent = Math.min(idx + 1, rounds.length) + '/' + rounds.length;
    hudAcc.textContent = Math.round((correct / Math.max(1, idx)) * 100) + '%';
    hudStreak.textContent = String(streak);
    hudTimer.textContent = timerOn ? 'On' : 'Off';
    progressBar.style.width = Math.round((idx / Math.max(1, rounds.length)) * 100) + '%';
  }

  function showFeedback(isCorrect, explain) {
    if (isCorrect) {
      feedback.innerHTML = '<span class="ok"><b>Correct!</b> ' + explain + '</span>';
      if (window.GSSound && window.GSSound.correct) window.GSSound.correct();
    } else {
      feedback.innerHTML = '<span class="bad"><b>Not quite.</b> ' + explain + '</span>';
      if (window.GSSound && window.GSSound.wrong) window.GSSound.wrong();
    }
  }

  // ‚îÄ‚îÄ Specificity Meter ‚îÄ‚îÄ
  function renderMeter(item, interactive) {
    meterArea.innerHTML = '';
    var wrap = document.createElement('div');
    wrap.className = 'meter-wrap';

    var label = document.createElement('div');
    label.className = 'meter-label';
    label.innerHTML = '<span>Any / General</span><span>The Specific One</span>';
    wrap.appendChild(label);

    var track = document.createElement('div');
    track.className = 'meter-track' + (interactive ? '' : ' disabled');
    track.id = 'meterTrack';

    var thumb = document.createElement('div');
    thumb.className = 'meter-thumb' + (!interactive ? ' hint' : '');
    thumb.id = 'meterThumb';

    var pos = interactive ? 50 : (item.meterPos || 50);
    thumb.style.left = pos + '%';

    track.appendChild(thumb);
    wrap.appendChild(track);
    meterArea.appendChild(wrap);

    if (interactive) {
      track.addEventListener('click', function(e) {
        if (locked) return;
        var rect = track.getBoundingClientRect();
        var pct = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        thumb.style.left = pct + '%';
        meterReady = true;
      });
    }
  }

  // ‚îÄ‚îÄ Render sentence with blank ‚îÄ‚îÄ
  function renderSentence(item) {
    sentenceDisplay.innerHTML = '';
    var parts = item.sentence.split('___');
    parts.forEach(function(part, i) {
      sentenceDisplay.appendChild(document.createTextNode(part));
      if (i < parts.length - 1) {
        var blank = document.createElement('span');
        blank.className = 'blank-slot active';
        blank.textContent = '___';
        blank.id = 'blankSlot';
        sentenceDisplay.appendChild(blank);
      }
    });
  }

  // ‚îÄ‚îÄ Render article buttons ‚îÄ‚îÄ
  function renderArticleButtons(item) {
    articleChoices.innerHTML = '';
    var opts = item.options || ["a","an","the","√ò"];
    var labels = 'ABCD';
    opts.forEach(function(art, i) {
      var btn = document.createElement('button');
      btn.className = 'article-btn';
      btn.type = 'button';
      btn.textContent = art;
      btn.setAttribute('data-label', labels[i]);
      btn.addEventListener('click', function() {
        if (locked) return;
        if (difficulty === 'field' && !meterReady) {
          feedback.innerHTML = '<span class="bad">‚ö†Ô∏è Position the specificity meter first!</span>';
          return;
        }
        locked = true;
        idx++;
        var isCorrect = art.toLowerCase() === item.answer.toLowerCase();
        if (isCorrect) { correct++; streak++; score += difficulty === 'field' ? 120 : 100; btn.classList.add('correct'); }
        else { streak = 0; btn.classList.add('wrong'); articleChoices.querySelectorAll('.article-btn').forEach(function(b) { if (b.textContent.toLowerCase() === item.answer.toLowerCase()) b.classList.add('correct'); }); }
        var blankSlot = document.getElementById('blankSlot');
        if (blankSlot) { blankSlot.textContent = item.answer === '√ò' ? '(no article)' : item.answer; blankSlot.className = 'blank-slot ' + (isCorrect ? 'correct-fill' : 'wrong-fill'); }
        var extra = item.nounType ? '<br><em>Noun:</em> "' + item.noun + '" ‚Äî ' + item.nounType : '';
        showFeedback(isCorrect, item.explain + extra);
        setTimeout(showRound, 1800);
      });
      articleChoices.appendChild(btn);
    });
  }

  // ‚îÄ‚îÄ Director paragraph mode ‚îÄ‚îÄ
  function renderDirectorParagraph(item) {
    sentenceDisplay.innerHTML = '';
    articleChoices.innerHTML = '';
    var para = document.createElement('div');
    para.className = 'director-para';

    var text = item.paragraph;
    var fragments = text.split(/\{(\d+)\}/);
    var blankEls = [];

    fragments.forEach(function(frag, fi) {
      if (fi % 2 === 0) {
        para.appendChild(document.createTextNode(frag));
      } else {
        var blankIdx = parseInt(frag, 10) - 1;
        var span = document.createElement('span');
        span.className = 'blank-slot active';
        span.textContent = '___';
        span.dataset.blankIdx = blankIdx;
        blankEls.push({el:span, idx:blankIdx, filled:null});
        para.appendChild(span);
      }
    });
    sentenceDisplay.appendChild(para);

    var currentBlank = 0;

    function renderDirectorChoices() {
      articleChoices.innerHTML = '';
      if (currentBlank >= item.blanks.length) return;
      var blankDef = item.blanks[currentBlank];
      var opts = ["a","an","the","√ò"];
      var labels = 'ABCD';

      var label = document.createElement('div');
      label.className = 'game-instruction';
      label.textContent = 'üìù Blank ' + (currentBlank + 1) + ' of ' + item.blanks.length + ' ‚Äî "' + blankDef.noun + '"';
      articleChoices.appendChild(label);

      var row = document.createElement('div');
      row.className = 'article-choices';
      row.style.margin = '8px 0';
      opts.forEach(function(art, i) {
        var btn = document.createElement('button');
        btn.className = 'article-btn';
        btn.type = 'button';
        btn.textContent = art;
        btn.setAttribute('data-label', labels[i]);
        btn.addEventListener('click', function() {
          if (locked) return;
          var isCorrect = art.toLowerCase() === blankDef.answer.toLowerCase();
          blankEls[currentBlank].filled = art;
          var el = blankEls[currentBlank].el;
          el.textContent = art === '√ò' ? '(√ò)' : art;
          el.className = 'blank-slot ' + (isCorrect ? 'correct-fill' : 'wrong-fill');

          if (!isCorrect) {
            btn.classList.add('wrong');
            row.querySelectorAll('.article-btn').forEach(function(b) { if (b.textContent.toLowerCase() === blankDef.answer.toLowerCase()) b.classList.add('correct'); });
          } else {
            btn.classList.add('correct');
          }

          currentBlank++;
          if (currentBlank >= item.blanks.length) {
            locked = true;
            idx++;
            var allCorrect = blankEls.every(function(b, bi) {
              return b.filled && b.filled.toLowerCase() === item.blanks[bi].answer.toLowerCase();
            });
            if (allCorrect) { correct++; streak++; score += 150; }
            else { streak = 0; }
            showFeedback(allCorrect, item.explain);
            setTimeout(showRound, 2200);
          } else {
            setTimeout(renderDirectorChoices, 600);
          }
        });
        row.appendChild(btn);
      });
      articleChoices.appendChild(row);
    }

    renderDirectorChoices();
  }

  // ‚îÄ‚îÄ Show Round ‚îÄ‚îÄ
  function showRound() {
    if (idx >= rounds.length) { endGame(); return; }
    locked = false;
    meterReady = false;
    feedback.textContent = '';
    articleChoices.innerHTML = '';
    meterArea.innerHTML = '';
    sentenceDisplay.innerHTML = '';
    var item = rounds[idx];

    sceneText.textContent = item.context;
    sceneIcon.textContent = item.icon;
    sceneLabel.textContent = item.scene;

    if (difficulty === 'rookie') {
      instruction.textContent = 'üéØ The meter shows a hint. Pick the correct article.';
      renderMeter(item, false);
      renderSentence(item);
      renderArticleButtons(item);
    } else if (difficulty === 'field') {
      instruction.textContent = 'üîç Position the meter first, then choose the article.';
      renderMeter(item, true);
      renderSentence(item);
      renderArticleButtons(item);
    } else {
      instruction.textContent = 'üïµÔ∏è Fill in all 3 blanks with the correct articles.';
      renderDirectorParagraph(item);
    }
    updateHud();
  }

  // ‚îÄ‚îÄ End Game ‚îÄ‚îÄ
  function endGame() {
    var acc = Math.round((correct / Math.max(1, idx)) * 100);
    document.getElementById('reportAcc').textContent = 'Accuracy: ' + acc + '% (' + correct + '/' + idx + ')';
    document.getElementById('reportScore').textContent = 'Score: ' + score + ' pts';
    document.getElementById('reportRec').textContent = acc >= 80 ? 'Recommendation: Advance to the next difficulty!' : 'Recommendation: Replay to master article usage.';
    document.getElementById('reportInsight').innerHTML = '<div class="skill-label" style="color:var(--teal)">GRAMMAR INSIGHT</div>' +
      '<p style="margin:6px 0 0;font-size:13px;line-height:1.6">Use <strong>"a/an"</strong> for first mentions and non-specific nouns. Use <strong>"the"</strong> when both speaker and listener know which one. Use <strong>no article (√ò)</strong> for general plurals and uncountable concepts. "An" precedes <strong>vowel sounds</strong>, not just vowel letters.</p>';
    document.getElementById('reportOverlay').classList.add('show');
    if (window.GSSound && window.GSSound.missionComplete) window.GSSound.missionComplete();
  }

  // ‚îÄ‚îÄ Hint ‚îÄ‚îÄ
  document.getElementById('hintBtn').addEventListener('click', function() {
    if (hints <= 0 || locked) return;
    hints--;
    document.getElementById('hintBtn').textContent = 'Hint (' + hints + ' left)';
    score = Math.max(0, score - 30);
    var item = rounds[idx];
    if (item) {
      if (difficulty === 'director' && item.blanks) {
        feedback.innerHTML = '<span class="ok">üí° Hint: Think about whether each noun is specific (the), first-mention (a/an), or general (√ò).</span>';
      } else {
        var hint = item.nounType ? '"' + item.noun + '" is ' + item.nounType + '.' : 'Think: is this noun specific or general?';
        feedback.innerHTML = '<span class="ok">üí° Hint: ' + hint + '</span>';
      }
    }
  });

  // ‚îÄ‚îÄ Start ‚îÄ‚îÄ
  document.getElementById('startBtn').addEventListener('click', function() {
    document.getElementById('onboardOverlay').classList.remove('show');
    buildRounds();
    showRound();
  });
  document.getElementById('endBtn').addEventListener('click', function() { idx = rounds.length; endGame(); });
  document.getElementById('replayBtn').addEventListener('click', function() {
    document.getElementById('reportOverlay').classList.remove('show');
    idx = 0; correct = 0; streak = 0; score = 0; hints = 2;
    document.getElementById('hintBtn').textContent = 'Hint (2 left)';
    buildRounds();
    showRound();
  });

  if (!timerOn) hudTimer.textContent = 'Off';
})();
</script>
</body>
</html>

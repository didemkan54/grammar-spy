<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grammar Spy™ | Mission Library</title>
    <link rel="stylesheet" href="core/theme.css" />
  </head>
  <body>
    <main class="gs-shell">
      <header id="topNav"></header>

      <section class="gs-panel">
        <h1>Mission Library</h1>
        <p class="gs-subtitle">
          Select a mission by grade band, cognitive level, grammar focus, or target skill tags.
          Configure launch controls, then deploy to game mode.
        </p>
      </section>

      <section class="gs-panel" aria-labelledby="teacher-controls-title">
        <h2 id="teacher-controls-title">Teacher Controls Panel</h2>
        <div class="gs-controls-grid">
          <label class="gs-field">
            <span class="gs-field-label">Mission Selector</span>
            <input id="missionSearch" class="gs-input" list="missionSuggestions" placeholder="Search mission by name" aria-label="Search missions" />
            <datalist id="missionSuggestions"></datalist>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Difficulty</span>
            <select id="difficultySelect" class="gs-select" aria-label="Select mission difficulty">
              <option value="rookie">Rookie</option>
              <option value="field" selected>Field Agent</option>
              <option value="director">Director</option>
            </select>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Question Count</span>
            <select id="questionCountSelect" class="gs-select" aria-label="Select question count">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="15">15</option>
              <option value="20">20</option>
              <option value="custom">Custom</option>
            </select>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Custom Count</span>
            <input id="customCountInput" class="gs-input" type="number" min="1" max="40" value="10" aria-label="Custom question count" />
          </label>
        </div>
        <div class="gs-button-row" style="margin-top: 12px;">
          <label class="gs-btn gs-btn-soft">
            <input id="soundToggle" type="checkbox" checked aria-label="Toggle sound" />
            Sound On
          </label>
          <label class="gs-btn gs-btn-soft">
            <input id="motionToggle" type="checkbox" aria-label="Toggle reduced motion" />
            Reduced Motion
          </label>
        </div>
      </section>

      <section class="gs-panel" aria-labelledby="library-filters-title">
        <h2 id="library-filters-title">Mission Filters</h2>
        <div class="gs-controls-grid">
          <label class="gs-field">
            <span class="gs-field-label">Grade Band</span>
            <select id="gradeFilter" class="gs-select" aria-label="Filter by grade band">
              <option value="">All</option>
              <option value="6-7">6-7</option>
              <option value="8-9">8-9</option>
              <option value="10-12">10-12</option>
            </select>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Cognitive Level</span>
            <select id="levelFilter" class="gs-select" aria-label="Filter by cognitive level">
              <option value="">All</option>
              <option value="1">Level 1</option>
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
            </select>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Grammar Focus</span>
            <select id="grammarFilter" class="gs-select" aria-label="Filter by grammar focus">
              <option value="">All</option>
            </select>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Retrieval Type</span>
            <select id="retrievalFilter" class="gs-select" aria-label="Filter by retrieval type">
              <option value="">All</option>
            </select>
          </label>
        </div>
        <div class="gs-controls-grid" style="margin-top: 10px;">
          <label class="gs-field">
            <span class="gs-field-label">Skill Tag</span>
            <select id="skillFilter" class="gs-select" aria-label="Filter by skill tag">
              <option value="">All skills</option>
            </select>
          </label>
          <div class="gs-field" style="align-self: end;">
            <button id="resetFiltersBtn" class="gs-btn" type="button">Reset Filters</button>
          </div>
        </div>
      </section>

      <section id="missionResults" class="gs-grid gs-grid-2" aria-live="polite"></section>
    </main>

    <div id="launchModalBackdrop" class="gs-modal-backdrop" data-open="false">
      <div class="gs-modal" role="dialog" aria-modal="true" aria-labelledby="launch-modal-title">
        <div class="gs-modal-head">
          <h2 id="launch-modal-title">Launch Mission</h2>
          <button id="closeLaunchModalBtn" class="gs-btn" type="button" aria-label="Close launch modal">Close</button>
        </div>
        <p id="launchMissionSummary" class="gs-subtitle"></p>

        <div class="gs-controls-grid" style="margin-top: 12px;">
          <label class="gs-field">
            <span class="gs-field-label">Game Type</span>
            <select id="modalGameType" class="gs-select" aria-label="Select game type"></select>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Tier</span>
            <select id="modalTier" class="gs-select" aria-label="Select mission tier">
              <option value="rookie">Rookie</option>
              <option value="field">Field Agent</option>
              <option value="director">Director</option>
            </select>
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Question Count</span>
            <input id="modalCount" class="gs-input" type="number" min="1" max="40" value="10" aria-label="Question count for launch" />
          </label>
          <label class="gs-field">
            <span class="gs-field-label">Timer</span>
            <select id="modalTimer" class="gs-select" aria-label="Toggle timer">
              <option value="off" selected>Off (Default)</option>
              <option value="on">On (Speed bonus active)</option>
            </select>
          </label>
        </div>

        <div class="gs-button-row" style="margin-top: 14px;">
          <button id="confirmLaunchBtn" class="gs-btn gs-btn-primary" type="button">Launch Mission</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { renderTopNav, applyReducedMotion, readQueryParams } from "./core/router.js";
      import { getProfile, saveProfile } from "./core/storage.js";
      import { listAllMissions, filterMissions, loadMission, getManifestSummary } from "./core/missionLoader.js";

      const topNav = document.getElementById("topNav");
      renderTopNav(topNav, "missions");

      const state = {
        allMissions: [],
        filteredMissions: [],
        previewCache: new Map(),
        selectedMissionId: null
      };

      const missionSearch = document.getElementById("missionSearch");
      const missionSuggestions = document.getElementById("missionSuggestions");
      const difficultySelect = document.getElementById("difficultySelect");
      const questionCountSelect = document.getElementById("questionCountSelect");
      const customCountInput = document.getElementById("customCountInput");
      const soundToggle = document.getElementById("soundToggle");
      const motionToggle = document.getElementById("motionToggle");

      const gradeFilter = document.getElementById("gradeFilter");
      const levelFilter = document.getElementById("levelFilter");
      const grammarFilter = document.getElementById("grammarFilter");
      const retrievalFilter = document.getElementById("retrievalFilter");
      const skillFilter = document.getElementById("skillFilter");
      const resetFiltersBtn = document.getElementById("resetFiltersBtn");
      const missionResults = document.getElementById("missionResults");

      const launchModalBackdrop = document.getElementById("launchModalBackdrop");
      const closeLaunchModalBtn = document.getElementById("closeLaunchModalBtn");
      const launchMissionSummary = document.getElementById("launchMissionSummary");
      const modalGameType = document.getElementById("modalGameType");
      const modalTier = document.getElementById("modalTier");
      const modalCount = document.getElementById("modalCount");
      const modalTimer = document.getElementById("modalTimer");
      const confirmLaunchBtn = document.getElementById("confirmLaunchBtn");

      const profile = getProfile();
      soundToggle.checked = Boolean(profile.settings?.soundOn ?? true);
      motionToggle.checked = Boolean(profile.settings?.reducedMotion ?? false);
      applyReducedMotion(motionToggle.checked);

      soundToggle.addEventListener("change", () => {
        const next = saveProfile({
          ...getProfile(),
          settings: { ...getProfile().settings, soundOn: soundToggle.checked }
        });
        soundToggle.checked = next.settings.soundOn;
      });

      motionToggle.addEventListener("change", () => {
        const next = saveProfile({
          ...getProfile(),
          settings: { ...getProfile().settings, reducedMotion: motionToggle.checked }
        });
        motionToggle.checked = next.settings.reducedMotion;
        applyReducedMotion(motionToggle.checked);
      });

      questionCountSelect.addEventListener("change", () => {
        customCountInput.disabled = questionCountSelect.value !== "custom";
        if (!customCountInput.disabled) customCountInput.focus();
      });
      customCountInput.disabled = questionCountSelect.value !== "custom";

      function selectedQuestionCount() {
        if (questionCountSelect.value === "custom") return Number(customCountInput.value) || 10;
        return Number(questionCountSelect.value) || 10;
      }

      function fillSelectOptions(selectEl, values) {
        const existing = selectEl.innerHTML;
        const baseOption = existing.includes("All") ? `<option value="">All</option>` : "";
        selectEl.innerHTML = `${baseOption}${values
          .map((value) => `<option value="${value}">${value}</option>`)
          .join("")}`;
      }

      async function getPreview(missionId) {
        if (state.previewCache.has(missionId)) return state.previewCache.get(missionId);
        const mission = await loadMission(missionId);
        const preview = (mission.items || []).slice(0, 3).map((item) => item.sentence);
        const gameTypes = mission.gameTypes || ["retrieval-raid"];
        state.previewCache.set(missionId, { preview, gameTypes });
        return { preview, gameTypes };
      }

      async function renderResults() {
        const criteria = {
          gradeBand: gradeFilter.value,
          cognitiveLevel: levelFilter.value,
          grammarFocus: grammarFilter.value,
          retrievalType: retrievalFilter.value,
          skills: skillFilter.value ? [skillFilter.value] : [],
          missionName: missionSearch.value.trim()
        };
        state.filteredMissions = await filterMissions(criteria);

        if (!state.filteredMissions.length) {
          missionResults.innerHTML = `<div class="gs-empty">No missions match the selected filters.</div>`;
          return;
        }

        const cards = await Promise.all(
          state.filteredMissions.map(async (mission) => {
            const { preview } = await getPreview(mission.missionId);
            const tags = (mission.skills || []).map((skill) => `<span class="gs-chip">${skill}</span>`).join("");
            const previewItems = preview.map((line) => `<li>${line}</li>`).join("");
            const tiers = (mission.availableTiers || ["rookie", "field", "director"])
              .map((tier) => {
                const className =
                  tier === "rookie"
                    ? "gs-badge gs-badge-rookie"
                    : tier === "field"
                    ? "gs-badge gs-badge-field"
                    : "gs-badge gs-badge-director";
                return `<span class="${className}">${tier}</span>`;
              })
              .join("");

            return `
              <article class="gs-card">
                <h3 class="gs-card-title">${mission.missionName}</h3>
                <p class="gs-card-sub">${mission.missionBrief}</p>
                <div class="gs-chip-row" style="margin: 10px 0 8px;">${tags}</div>
                <div class="gs-chip-row" style="margin-bottom: 10px;">${tiers}</div>
                <p class="gs-field-label">Preview</p>
                <ul class="gs-list">${previewItems}</ul>
                <div class="gs-button-row" style="margin-top: 10px;">
                  <button class="gs-btn gs-btn-soft" data-preview-id="${mission.missionId}" type="button">Preview</button>
                  <button class="gs-btn gs-btn-primary" data-launch-id="${mission.missionId}" type="button">Launch Mission</button>
                </div>
              </article>
            `;
          })
        );
        missionResults.innerHTML = cards.join("");
      }

      function openLaunchModal(missionId) {
        state.selectedMissionId = missionId;
        const mission = state.allMissions.find((row) => row.missionId === missionId);
        if (!mission) return;
        launchMissionSummary.textContent = `${mission.missionName} · ${mission.grammarFocus} · Grade ${mission.gradeBand} · Level ${mission.cognitiveLevel}`;
        modalTier.value = difficultySelect.value || "field";
        modalCount.value = selectedQuestionCount();
        modalTimer.value = "off";

        getPreview(missionId).then(({ gameTypes }) => {
          modalGameType.innerHTML = gameTypes
            .map((type) => `<option value="${type}">${type}</option>`)
            .join("");
        });

        launchModalBackdrop.dataset.open = "true";
      }

      function closeLaunchModal() {
        launchModalBackdrop.dataset.open = "false";
      }

      missionResults.addEventListener("click", async (event) => {
        const launchButton = event.target.closest("[data-launch-id]");
        const previewButton = event.target.closest("[data-preview-id]");

        if (previewButton) {
          const mission = await loadMission(previewButton.dataset.previewId);
          alert(mission.items.slice(0, 3).map((item, i) => `${i + 1}. ${item.sentence}`).join("\n\n"));
        }
        if (launchButton) {
          openLaunchModal(launchButton.dataset.launchId);
        }
      });

      closeLaunchModalBtn.addEventListener("click", closeLaunchModal);
      launchModalBackdrop.addEventListener("click", (event) => {
        if (event.target === launchModalBackdrop) closeLaunchModal();
      });
      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && launchModalBackdrop.dataset.open === "true") closeLaunchModal();
      });

      confirmLaunchBtn.addEventListener("click", () => {
        if (!state.selectedMissionId) return;
        const count = Math.max(1, Number(modalCount.value || selectedQuestionCount()));
        const url = new URL("games/launch.html", window.location.href);
        url.searchParams.set("missionId", state.selectedMissionId);
        url.searchParams.set("gameType", modalGameType.value || "retrieval-raid");
        url.searchParams.set("tier", modalTier.value || "field");
        url.searchParams.set("count", count);
        url.searchParams.set("timer", modalTimer.value);
        window.location.href = url.toString();
      });

      [
        missionSearch,
        gradeFilter,
        levelFilter,
        grammarFilter,
        retrievalFilter,
        skillFilter
      ].forEach((el) => {
        el.addEventListener("input", renderResults);
        el.addEventListener("change", renderResults);
      });

      resetFiltersBtn.addEventListener("click", () => {
        missionSearch.value = "";
        gradeFilter.value = "";
        levelFilter.value = "";
        grammarFilter.value = "";
        retrievalFilter.value = "";
        skillFilter.value = "";
        renderResults();
      });

      state.allMissions = await listAllMissions();
      const summary = getManifestSummary(state.allMissions);

      missionSuggestions.innerHTML = state.allMissions
        .map((mission) => `<option value="${mission.missionName}"></option>`)
        .join("");

      fillSelectOptions(grammarFilter, summary.grammarFocus);
      fillSelectOptions(retrievalFilter, summary.retrievalTypes);
      fillSelectOptions(skillFilter, summary.skills);

      const query = readQueryParams();
      if (query.gradeBand) gradeFilter.value = query.gradeBand;
      if (query.cognitiveLevel) levelFilter.value = query.cognitiveLevel;
      if (query.missionId) {
        const direct = state.allMissions.find((m) => m.missionId === query.missionId);
        if (direct) missionSearch.value = direct.missionName;
      }
      await renderResults();
    </script>
  </body>
</html>

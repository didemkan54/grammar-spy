<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grammar Spyâ„¢ | Mission Launch</title>
    <link rel="stylesheet" href="core/theme.css" />
    <style>
      .mission-card{background:#fff;border:1px solid #d9dee6;border-radius:16px;padding:22px;box-shadow:0 4px 14px rgba(11,16,32,.06);transition:transform .2s ease,box-shadow .2s ease}
      .mission-card:hover{transform:translateY(-3px);box-shadow:0 8px 22px rgba(11,16,32,.1)}
      .mission-card h3{margin:0 0 6px;font-size:20px;color:#0b1020}
      .mission-card .brief{margin:0 0 12px;color:#4a5568;font-size:14px;line-height:1.5}
      .skill-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
      .skill-chip{background:#e8f4f5;color:#1f5f63;font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;letter-spacing:.03em}
      .preview-box{background:#f8fafc;border:1px solid #e4e8ef;border-radius:10px;padding:12px 14px;margin-bottom:14px}
      .preview-box p{margin:0 0 2px;font-size:13px;color:#4a5568;line-height:1.5}
      .preview-box .label{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:#1f5f63;margin-bottom:6px}
      .card-actions{display:flex;gap:8px;flex-wrap:wrap}
      .card-actions .gs-btn{font-size:13px;padding:10px 18px}
      .settings-bar{background:#fff;border:1px solid #d9dee6;border-radius:14px;padding:16px 20px;display:flex;gap:16px;align-items:end;flex-wrap:wrap;box-shadow:0 2px 8px rgba(11,16,32,.04)}
      .settings-bar label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#4a5568;display:flex;flex-direction:column;gap:4px}
      .settings-bar select,.settings-bar input{border:1px solid #d9dee6;border-radius:8px;padding:8px 10px;font-size:14px;color:#16223a}
      .search-box{flex:1;min-width:180px}
      .search-box input{width:100%;border:2px solid #d9dee6;border-radius:10px;padding:10px 14px;font-size:15px;transition:border-color .15s}
      .search-box input:focus{border-color:#1f5f63;outline:none}
      .results-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
      @media(max-width:800px){.results-grid{grid-template-columns:1fr}.settings-bar{flex-direction:column}}
      .empty-state{text-align:center;padding:40px;color:#7a8698;font-size:16px}
      /* Preview modal */
      .preview-overlay{position:fixed;inset:0;background:rgba(11,16,32,.4);display:none;place-items:center;padding:16px;z-index:200;backdrop-filter:blur(3px)}
      .preview-overlay.show{display:grid}
      .preview-modal{width:min(520px,100%);background:#fff;border-radius:18px;padding:24px;box-shadow:0 16px 40px rgba(11,16,32,.2)}
      .preview-modal h3{margin:0 0 4px;color:#0b1020;font-size:20px}
      .preview-modal .sub{margin:0 0 16px;color:#4a5568;font-size:13px}
      .preview-modal .sample{background:#f8fafc;border:1px solid #e4e8ef;border-radius:10px;padding:14px;margin-bottom:10px}
      .preview-modal .sample p{margin:0 0 8px;font-size:14px;color:#16223a;line-height:1.5}
      .preview-modal .sample p:last-child{margin:0}
      .preview-modal .sample .num{color:#1f5f63;font-weight:800;margin-right:6px}
    </style>
  </head>
  <body>
    <main class="gs-shell">
      <header id="topNav"></header>

      <section class="gs-panel">
        <h1>Mission Launch</h1>
        <p class="gs-subtitle">Browse missions and launch one when you're ready. Each mission focuses on a specific grammar skill.</p>
      </section>

      <!-- Simple settings bar -->
      <div class="settings-bar">
        <div class="search-box">
          <input id="missionSearch" type="text" placeholder="Search missions..." aria-label="Search missions" />
        </div>
        <label>Difficulty
          <select id="difficultySelect" aria-label="Difficulty">
            <option value="rookie">Rookie</option>
            <option value="field" selected>Field Agent</option>
            <option value="director">Director</option>
          </select>
        </label>
        <label>Questions
          <select id="questionCountSelect" aria-label="Question count">
            <option value="6">6</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
            <option value="20">20</option>
          </select>
        </label>
        <label>Timer
          <select id="timerSelect" aria-label="Timer">
            <option value="off" selected>Off</option>
            <option value="on">On</option>
          </select>
        </label>
      </div>

      <!-- Mission cards -->
      <div id="missionResults" class="results-grid" aria-live="polite"></div>
    </main>

    <!-- Preview modal -->
    <div id="previewOverlay" class="preview-overlay">
      <div class="preview-modal" role="dialog" aria-modal="true">
        <h3 id="previewTitle">Mission Preview</h3>
        <p class="sub" id="previewSub"></p>
        <div id="previewSamples"></div>
        <div class="card-actions" style="margin-top:14px">
          <button class="gs-btn gs-btn-primary" id="previewLaunchBtn" type="button">Launch This Mission</button>
          <button class="gs-btn" id="previewCloseBtn" type="button">Close</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { renderTopNav, readQueryParams } from "./core/router.js";
      import { listAllMissions, loadMission, getManifestSummary } from "./core/missionLoader.js";

      renderTopNav(document.getElementById("topNav"), "missions");

      const missionSearch = document.getElementById("missionSearch");
      const difficultySelect = document.getElementById("difficultySelect");
      const questionCountSelect = document.getElementById("questionCountSelect");
      const timerSelect = document.getElementById("timerSelect");
      const missionResults = document.getElementById("missionResults");
      const previewOverlay = document.getElementById("previewOverlay");
      const previewTitle = document.getElementById("previewTitle");
      const previewSub = document.getElementById("previewSub");
      const previewSamples = document.getElementById("previewSamples");
      const previewLaunchBtn = document.getElementById("previewLaunchBtn");
      const previewCloseBtn = document.getElementById("previewCloseBtn");

      let allMissions = [];
      let previewCache = new Map();
      let activeMissionId = null;

      async function getPreview(missionId) {
        if (previewCache.has(missionId)) return previewCache.get(missionId);
        const mission = await loadMission(missionId);
        const preview = (mission.items || []).slice(0, 3).map(item => item.sentence);
        const gameTypes = mission.gameTypes || ["clue-trail"];
        previewCache.set(missionId, { preview, gameTypes });
        return { preview, gameTypes };
      }

      async function renderResults() {
        const query = missionSearch.value.trim().toLowerCase();
        const filtered = allMissions.filter(m =>
          !query || m.missionName.toLowerCase().includes(query) || (m.missionBrief || "").toLowerCase().includes(query)
        );

        if (!filtered.length) {
          missionResults.innerHTML = '<div class="empty-state">No missions match your search.</div>';
          return;
        }

        const cards = await Promise.all(filtered.map(async mission => {
          const { preview } = await getPreview(mission.missionId);
          const skills = (mission.skills || []).map(s =>
            '<span class="skill-chip">' + s.replace(/_/g, " ") + '</span>'
          ).join("");

          const previewLines = preview.map(line => '<p>' + line + '</p>').join("");

          return `
            <article class="mission-card">
              <h3>${mission.missionName.replace("Mission: ", "")}</h3>
              <p class="brief">${mission.missionBrief}</p>
              <div class="skill-chips">${skills}</div>
              <div class="preview-box">
                <div class="label">Sample Questions</div>
                ${previewLines}
              </div>
              <div class="card-actions">
                <button class="gs-btn gs-btn-primary" data-launch="${mission.missionId}" type="button">Play Mission</button>
                <button class="gs-btn" data-preview="${mission.missionId}" type="button">Preview</button>
              </div>
            </article>
          `;
        }));
        missionResults.innerHTML = cards.join("");
      }

      function launchMission(missionId) {
        const mission = allMissions.find(m => m.missionId === missionId);
        if (!mission) return;
        const gameTypes = previewCache.get(missionId)?.gameTypes || ["clue-trail"];
        const url = new URL("games/launch.html", window.location.href);
        url.searchParams.set("missionId", missionId);
        url.searchParams.set("gameType", gameTypes[0]);
        url.searchParams.set("tier", difficultySelect.value);
        url.searchParams.set("count", questionCountSelect.value);
        url.searchParams.set("timer", timerSelect.value);
        window.location.href = url.toString();
      }

      async function openPreview(missionId) {
        activeMissionId = missionId;
        const mission = allMissions.find(m => m.missionId === missionId);
        if (!mission) return;
        const data = await loadMission(missionId);
        const samples = (data.items || []).slice(0, 5);

        previewTitle.textContent = mission.missionName.replace("Mission: ", "");
        previewSub.textContent = mission.missionBrief;
        previewSamples.innerHTML = samples.map((item, i) =>
          '<div class="sample"><p><span class="num">' + (i + 1) + '.</span> ' + item.sentence + '</p></div>'
        ).join("");
        previewOverlay.classList.add("show");
      }

      function closePreview() {
        previewOverlay.classList.remove("show");
      }

      missionResults.addEventListener("click", e => {
        const launchBtn = e.target.closest("[data-launch]");
        const previewBtn = e.target.closest("[data-preview]");
        if (launchBtn) launchMission(launchBtn.dataset.launch);
        if (previewBtn) openPreview(previewBtn.dataset.preview);
      });

      previewCloseBtn.addEventListener("click", closePreview);
      previewOverlay.addEventListener("click", e => { if (e.target === previewOverlay) closePreview(); });
      window.addEventListener("keydown", e => { if (e.key === "Escape") closePreview(); });
      previewLaunchBtn.addEventListener("click", () => { if (activeMissionId) launchMission(activeMissionId); });

      missionSearch.addEventListener("input", renderResults);

      allMissions = await listAllMissions();
      await renderResults();
    </script>
    <script src="gs-animations.js"></script>
  </body>
</html>
